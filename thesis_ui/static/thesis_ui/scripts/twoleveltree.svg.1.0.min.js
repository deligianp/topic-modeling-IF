function calculateDrawableWidth(e){let t=document.getElementById(e);if(null!=t){let e=getComputedStyle(t),n=parseFloat(e.paddingLeft)+parseFloat(e.paddingRight),s=parseFloat(e.borderLeftWidth)+parseFloat(e.borderRightWidth);return t.clientWidth-n-s}}function createSVG(e,t){let n=calculateDrawableWidth(e),s=document.createElementNS("http://www.w3.org/2000/svg","svg");s.setAttribute("width",n+"px");let i=Math.ceil(n*t);return document.getElementById(e).style="height:"+i+"px;overflow:scroll",s.setAttribute("height",i+"px"),s}class TwoLevelTree{constructor(e){this.d3Svg=d3.select(e),this.svg=e,this.data=[],this.nodes=[],this.links=[],this.parents={length:0},this.children={length:0},this.focusedNode=null;let t=parseInt(this.d3Svg.style("width"));this.presentation={firstLevelLabel:"First level",secondLevelLabel:"Second level",minimumHeight:parseInt(this.d3Svg.style("height")),drawHeight:parseInt(this.d3Svg.style("height")),nodeR:Math.ceil(.01*parseFloat(t)),treeTextSize:Math.ceil(.018*parseFloat(t)),yPos0:Math.floor(.25*parseFloat(t)),yPos1:Math.floor(.75*parseFloat(t)),verticalMargin:Math.ceil(.05*parseFloat(t)),primaryColor:"#007bff",primaryColorEvent:"#97c9ff",secondaryColor:"#7f00ff",secondaryColorEvent:"#b27fe6",linkColor:"#000",linkColorEvent:"#c3c3c3"}}parseTree(){let e=this;this.data.forEach(function(t){if(t.name in e.parents)throw"Multiple definitions for parent "+t.name;{let n={};n.name=t.name,n.children=t.children.map(function(t){let s=t.childNode,i=t.connectionValue;if(s.name in e.children)return e.children[s.name].associatedNodes.push(n),e.links.push({source:n,target:e.children[s.name],connectionValue:i}),e.children[s.name];{let t={};t.name=s.name,t.y=0,t.x=0,t.depth=1,t.nwName="t_"+t.name.replace(/ /g,"_"),t.associatedNodes=[],t.associatedNodes.push(n);for(let e in s)s.hasOwnProperty(e)&&!t.hasOwnProperty(e)&&(t[e]=s[e]);return e.children[t.name]=t,e.children.length+=1,e.links.push({source:n,target:t,connectionValue:i}),e.nodes.push(t),t}}),n.y=0,n.x=0,n.depth=0,n.nwName="s_"+n.name.replace(" ","_"),n.associatedNodes=n.children;for(let e in t)t.hasOwnProperty(e)&&!n.hasOwnProperty(e)&&(n[e]=t[e]);return e.parents[n.name]=n,e.parents.length+=1,e.nodes.push(n),n}})}updateData(e){this.data=e,this.parseTree(),this.calculateLayout(),this.paintTree()}calculateNodeX(){let e=Math.floor((this.presentation.drawHeight-2*this.parents.length*this.presentation.nodeR)/(this.parents.length+1)),t=Math.floor((this.presentation.drawHeight-2*this.children.length*this.presentation.nodeR)/(this.children.length+1)),n=0;for(let t in this.parents)"length"!==t&&this.parents.hasOwnProperty(t)&&(this.parents[t].x=(n+1)*e+2*n*this.presentation.nodeR+this.presentation.nodeR,n+=1);let s=0;for(let e in this.children)"length"!==e&&this.children.hasOwnProperty(e)&&(this.children[e].x=(s+1)*t+2*s*this.presentation.nodeR+this.presentation.nodeR,s+=1)}calculateNodeY(){let e=0;for(let t in this.parents)"length"!==t&&this.parents.hasOwnProperty(t)&&(this.parents[t].y=this.presentation.yPos0,e+=1);let t=0;for(let e in this.children)"length"!==e&&this.children.hasOwnProperty(e)&&(this.children[e].y=this.presentation.yPos1,t+=1)}calculateLayout(){let e=Math.max(this.parents.length,this.children.length)*(2*this.presentation.nodeR+this.presentation.verticalMargin)+this.presentation.verticalMargin;this.presentation.drawHeight=Math.max(this.presentation.minimumHeight,e),this.calculateNodeY(),this.calculateNodeX()}linkNodes(){let e=[];for(let t in this.parents)if("length"!==t&&this.parents.hasOwnProperty(t)){let n=this.parents[t];for(let t in n.children)if("length"!==t&&n.children.hasOwnProperty(t)){let s=n.children[t],i={source:n,target:s};e.push(i),n.associatedLinks.push(i),s.associatedLinks.push(i)}}this.links=e}paintTree(){let e=this;e.d3Svg.attr("height",e.presentation.drawHeight+"px");let t=d3.select("body").append("div").style("position","absolute").style("display","none").style("background-color","white").style("border","solid").style("border-width","1px").style("border-radius","5px").style("padding","0px 10px"),n=this.d3Svg.selectAll(".node").data(this.nodes).enter().append("g").attr("class","node").attr("id",function(e){return e.nwName}).attr("transform",function(e){return"translate("+e.y+","+e.x+")"});n.append("circle").attr("r",e.presentation.nodeR).attr("fill","#007bff"),n.append("text").attr("text-anchor",function(e){return 0===e.depth?"end":"start"}).attr("font-family",'"Lucida Console", Monaco, monospace, monospace').attr("font-size",e.presentation.treeTextSize).attr("fill",function(e){return e.queried?"#000000":"#666666"}).attr("transform",function(t){return 0===t.depth?"translate(-"+(e.presentation.nodeR+1)+", 10)":"translate("+(e.presentation.nodeR+1)+", 10)"}).text(function(e){return e.name.length<=12?e.name:e.name.substring(0,9)+"..."});let s=d3.svg.diagonal().projection(function(t){return 0===t.depth?[t.y+e.presentation.nodeR,t.x]:[t.y-e.presentation.nodeR,t.x]}),i=this.d3Svg.selectAll(".link").data(this.links).enter().append("g").attr("class","link").attr("id",function(e){return e.source.nwName+"_"+e.target.nwName});i.append("path").attr("fill","none").attr("stroke","#000").attr("d",s).attr("id",function(e){return"path_"+e.source.nwName+"_"+e.target.nwName});i.append("text").attr("dy","-4").style("display","none").append("textPath").attr("xlink:href",function(e){return"#path_"+e.source.nwName+"_"+e.target.nwName}).attr("startOffset","50%").text(function(e){return Math.round(1e3*parseFloat(e.connectionValue))/1e3}),n.select("circle").on("mouseover",function(n){null==e.focusedNode&&d3.select(this).style("fill",e.presentation.secondaryColor),t.style("display","block").html("<p><strong>"+n.name+":</strong></p><p>"+n.meta_text.join("</br>")+"</p>")}).on("mousemove",function(){t.style("top",event.pageY+2+"px").style("left",event.pageX+2+"px")}).on("mouseout",function(){null==e.focusedNode&&d3.select(this).style("fill","#007bff"),t.style("display","none")}).on("click",function(t){e.switch_focus(t)})}switch_focus(e){let t=this.focusedNode;null!=this.focusedNode&&this.raise_focus(this.focusedNode),t!==e&&this.focus(e)}focus(e){let t=e.nwName;this.d3Svg.selectAll(".node circle").style("fill",this.presentation.primaryColorEvent),this.d3Svg.selectAll(".link path").style("stroke",this.presentation.linkColorEvent);for(let n in e.associatedNodes){let s,i,r=e.associatedNodes[n];0===e.depth?(s=t,i=r.nwName,this.d3Svg.select("#"+i+" circle").style("fill",this.presentation.secondaryColor)):(s=r.nwName,i=t,this.d3Svg.select("#"+s+" circle").style("fill",this.presentation.secondaryColor));let l=this.d3Svg.select("#"+s+"_"+i);l.select("path").style("stroke",this.presentation.linkColor).style("stroke-width","3px"),l.select("text").style("display","inline")}this.d3Svg.select("#"+t+" circle");this.d3Svg.select("#"+t+" circle").style("fill",this.presentation.secondaryColor),this.focusedNode=e}raise_focus(){this.d3Svg.selectAll(".node circle").style("fill",this.presentation.primaryColor);let e=this.d3Svg.selectAll(".link");e.select("path").style("stroke",this.presentation.linkColor).style("stroke-width","1px"),e.select("text").style("display","none"),this.focusedNode=null}}